/*
  (c) LudvÃ­k Prokopec
  License: MIT
*/
(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.ReactiveHTML=b())})(this,function(){"use strict";function a(a){return"object"==typeof a&&null!==a}function b(a){return Object.getPrototypeOf(a)}function c(a){let b={},c={};for(const[d,e]of Object.entries(a))d.startsWith("on")&&(b[d.replace("on","")]=e,delete a[d]),"style"===d&&(c=e,delete a[d]);return{attrs:a,events:b,styles:c}}function d(a){return a.reduce(function(a,b){return a.concat(Array.isArray(b)?d(b):b)},[])}function e(c){if(!a(c)||!b(c)||!b(b(c)))return c;let d=b(b(c));return"Component"===d.constructor.name&&b(d).isPrototypeOf(n)?(c.Vnode.realDOM=null,c.Vnode):c}function f(a){return a.map(a=>e(a))}function g(a){const c=b(a),d=c.Element.bind(a)(a.props,a.states);if(a.Vnode.realDOM){const b=q(a.Vnode,d);d.realDOM=b(a.Vnode.realDOM)}Object.assign(a.Vnode,d),j(c.onComponentUpdate,a)}function h(a,b,c=!0,d=!0){const e=new MutationObserver((e,f)=>{e.forEach(e=>{Array.from(e.addedNodes).forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(d&&e.matches(a)||e.localName===a)&&(b(e),c&&f.disconnect())})})});return e.observe(document.documentElement,{childList:!0,subtree:!0}),e}function i(a,b,c){return c?b.replaceWith(a):b.appendChild(a),a}function j(a,b,...c){return void 0===a?void 0:a.bind(b)(...c)}function k(b){if(!a(b))return document.createTextNode(b);const c=document.createElement(b.tagName);for(const[a,d]of Object.entries(b.attrs))c.setAttribute(a,d);for(const[a,d]of Object.entries(b.events))c.addEventListener(a,d);for(const[a,d]of Object.entries(b.styles))c.style[a]=d;return b.children.forEach(a=>{const b=k(a);c.appendChild(b)}),null===b.realDOM&&(b.realDOM=c),c}function l(a,b){const c=[];for(let d=0;d<Math.min(a.length,b.length);d++)c.push([a[d],b[d]]);return c}function m(a,b){const c=[];for(const[d,e]of Object.entries(b))e!==a[d]&&c.push(function(a){return"value"===d&&(a.value=e),a.setAttribute(d,e),a});for(const d in a)d in b||c.push(function(a){return a.removeAttribute(d),a});return function(a){for(const b of c)b(a)}}const n={Component:class{constructor(c={}){const d=b(this),e={classLink:this,get(b,c){return a(b[c])&&("Object"===b[c].constructor.name||Array.isArray(b[c]))?new Proxy(b[c],e):b[c]},set(a,b,c){return a[b]=c,g(this.classLink),!0}};return this.props=new Proxy(c,e),void 0===d.constructor.__states__?(d.constructor.__states__=this.states=new Proxy(d.setStates?d.setStates.bind(this)(this.props):{},e),j(d.onComponentInit,this)):this.states=d.constructor.__states__,this.Vnode=d.Element.bind(this)(this.props,this.states),j(d.onComponentCreate,this),this}},Observable:class{constructor(a){if("function"!=typeof a)throw Error(`Observable subscriber must be function, your subscriber has value: ${a}`);return this.subscriber=a,this.effectArray=new Set,this}subscribe(a){if("function"!=typeof a)return this;const c=this.effectArray;return b(a).assign=function(a){return this(a),c.forEach(a=>{g(a)}),this},this.subscriber.apply(this,[a]),this}effect(...a){return a.forEach(a=>{this.effectArray.add(a)}),this}},Dispatcher:class{constructor(a,b){this.obs=h(a,function(a){const c={};return Array.from(a.attributes).forEach(a=>{c[a.nodeName]=new Function(`"use strict"; return(${a.nodeValue})`)()}),n.Render(new b(c),a,!0)},!1,!1)}disconnect(){return this.obs.disconnect()}},render:function(a,c,d=!1){const f=k(e(a)),g=b(a);return j(g.onComponentRender,a),j(g.onComponentMount,a),i(f,c,d)},elementReady:function(a,b){h(a,b)},createElement:function(a,b={},...e){null===b&&(b={});const g=c(b);return{tagName:a,attrs:g.attrs,children:f(d(e)),events:g.events,styles:g.styles}}},o=(a,b)=>{const c=[];a.forEach((a,d)=>{c.push(q(a,b[d]))});const d=[];for(const c of b.slice(a.length))d.push(function(a){return a.appendChild(k(c)),a});return function(a){for(const[b,d]of l(c,a.childNodes))b(d);for(const b of d)b(a);return a}},p=(a,b)=>{const c=[];for(const[d,e]of Object.entries(b))e!==a[d]&&c.push(function(a){return a.style[d]=e,a});for(const d in a)d in b||c.push(function(a){return a.style[d]=null,a});return function(a){for(const b of c)b(a)}},q=(b,c)=>{if(c===void 0)return function(a){a.remove()};if(!a(b)||!a(c))return b===c?()=>void 0:function(a){const b=k(c);return a.replaceWith(b),b};if(b.tagName!==c.tagName)return function(a){const b=k(c);return a.replaceWith(b),b};const d=m(b.attrs,c.attrs),e=o(b.children,c.children),f=p(b.styles,c.styles);return function(a){return d(a),e(a),f(a),a}};return n});
